<!DOCTYPE html>
<html lang="hi" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Verification - डिवाइस वेरिफिकेशन</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: var(--bs-light);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border-radius: 15px;
        }
        .verification-icon {
            font-size: 4rem;
            color: var(--bs-primary);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left: 4px solid var(--bs-primary);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .device-info {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            border-left: 4px solid var(--bs-primary);
        }
        .status-success {
            color: #28a745;
            font-size: 5rem;
            animation: bounce 1s ease-in-out;
        }
        .status-error {
            color: #dc3545;
            font-size: 5rem;
            animation: shake 0.5s ease-in-out;
        }
        @keyframes bounce {
            0%, 20%, 60%, 100% { transform: translateY(0); }
            40% { transform: translateY(-20px); }
            80% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .progress-bar {
            background: linear-gradient(45deg, var(--bs-primary), var(--bs-info));
            animation: progress-move 2s linear infinite;
        }
        @keyframes progress-move {
            0% { background-position: 0 0; }
            100% { background-position: 40px 0; }
        }
        .footer-text {
            font-size: 0.85rem;
            opacity: 0.7;
        }
        .telegram-btn {
            background: linear-gradient(45deg, #0088cc, #00aaff);
            border: none;
            transition: all 0.3s ease;
        }
        .telegram-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.4);
        }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <!-- Header -->
                <div class="text-center mb-4">
                    <h1><i class="fas fa-shield-alt me-2 text-primary"></i>Device Verification</h1>
                    <p class="text-muted">सुरक्षित और विश्वसनीय डिवाइस वेरिफिकेशन</p>
                </div>

                <!-- Main Card -->
                <div class="card">
                    <div class="card-body">
                        <!-- Loading State -->
                        <div id="loadingState" class="text-center py-4">
                            <div class="loading-spinner mb-3"></div>
                            <h5>Device की जानकारी collect कर रहे हैं...</h5>
                            <p class="text-muted">कृपया थोड़ा wait करें</p>
                            <div class="progress mt-3" style="height: 8px;">
                                <div class="progress-bar" role="progressbar" style="width: 0%" id="loadingProgress"></div>
                            </div>
                        </div>

                        <!-- Verification Form -->
                        <div id="verificationForm" class="d-none">
                            <div class="text-center mb-4">
                                <i class="fas fa-mobile-alt verification-icon"></i>
                                <h4 class="mt-3">अपना Device Verify करें</h4>
                                <p class="text-muted">यह process safe और secure है</p>
                            </div>

                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>क्यों जरूरी है?</strong> हम आपके device को verify कर रहे हैं ताकि एक device से multiple accounts का misuse न हो सके।
                            </div>

                            <div class="mb-3">
                                <label class="form-label"><i class="fab fa-telegram me-2"></i>Telegram User ID</label>
                                <input type="text" class="form-control" id="telegramUserId" readonly>
                            </div>

                            <div class="device-info">
                                <h6><i class="fas fa-laptop me-2"></i>Device की जानकारी</h6>
                                <div id="deviceDetails" class="mt-2">
                                    <small class="text-muted">Loading device information...</small>
                                </div>
                            </div>

                            <button type="button" class="btn btn-primary w-100 mt-3" onclick="verifyDevice()" id="verifyBtn">
                                <i class="fas fa-check me-2"></i>Device को Verify करें
                            </button>
                        </div>

                        <!-- Result State -->
                        <div id="resultState" class="d-none text-center py-4">
                            <div id="resultIcon" class="mb-3">
                                <!-- Icon will be inserted here -->
                            </div>
                            <h4 id="resultTitle"></h4>
                            <p id="resultMessage" class="text-muted"></p>
                            <button class="btn telegram-btn mt-3" onclick="goBackToBot()">
                                <i class="fab fa-telegram me-2"></i>Bot पर वापस जाएं
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Privacy Notice -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h6><i class="fas fa-lock me-2 text-warning"></i>Privacy & Security</h6>
                        <small class="footer-text">
                            हम सिर्फ anonymous device fingerprint data collect करते हैं (browser info, screen resolution, timezone) 
                            abuse prevent करने के लिए। कोई personal information store या share नहीं की जाती है। 
                            यह data सिर्फ multiple account prevention के लिए use होता है।
                        </small>
                    </div>
                </div>

                <!-- Instructions Card -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h6><i class="fas fa-question-circle me-2 text-info"></i>कैसे काम करता है?</h6>
                        <small class="footer-text">
                            <ol class="mb-0">
                                <li>हम आपके device की unique fingerprint बनाते हैं</li>
                                <li>यह fingerprint आपके account से link हो जाती है</li>
                                <li>अगर कोई और इस device से verify करने की कोशिश करेगा तो fail हो जाएगा</li>
                                <li>एक device = एक account policy maintain होती है</li>
                            </ol>
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Configuration - यहाँ अपना deployed bot URL डालें
        const API_BASE_URL = 'https://your-replit-url.replit.dev'; // आपका Replit bot URL यहाँ होगा
        
        let deviceFingerprint = null;
        let telegramUserId = null;

        // Device Fingerprinting Functions
        async function generateDeviceFingerprint() {
            const fingerprint = {};
            
            try {
                // Basic browser information
                fingerprint.userAgent = navigator.userAgent;
                fingerprint.language = navigator.language || navigator.languages[0];
                fingerprint.platform = navigator.platform;
                fingerprint.cookieEnabled = navigator.cookieEnabled;
                fingerprint.doNotTrack = navigator.doNotTrack || 'unknown';
                fingerprint.hardwareConcurrency = navigator.hardwareConcurrency || 0;
                
                // Screen information
                fingerprint.screen = `${screen.width}x${screen.height}`;
                fingerprint.colorDepth = screen.colorDepth;
                fingerprint.pixelDepth = screen.pixelDepth || screen.colorDepth;
                
                // Timezone
                try {
                    fingerprint.timezone = Intl.DateTimeFormat().resolvedOptions().timeZone;
                } catch (e) {
                    fingerprint.timezone = 'unknown';
                }
                fingerprint.timezoneOffset = new Date().getTimezoneOffset();
                
                // Canvas fingerprinting
                fingerprint.canvas = await generateCanvasFingerprint();
                
                // WebGL information
                fingerprint.webgl = await getWebGLInfo();
                
                // Audio context fingerprinting
                fingerprint.audio = await generateAudioFingerprint();
                
                // Available fonts detection
                fingerprint.fonts = await detectAvailableFonts();
                
                // Battery API (if available)
                try {
                    if ('getBattery' in navigator) {
                        const battery = await navigator.getBattery();
                        fingerprint.battery = {
                            charging: battery.charging,
                            level: Math.round(battery.level * 100)
                        };
                    }
                } catch (e) {
                    fingerprint.battery = null;
                }
                
                // Connection information
                if ('connection' in navigator && navigator.connection) {
                    fingerprint.connection = {
                        effectiveType: navigator.connection.effectiveType || 'unknown',
                        downlink: navigator.connection.downlink || 0
                    };
                }
                
                // Additional device info
                fingerprint.touchSupport = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
                fingerprint.screenOrientation = screen.orientation ? screen.orientation.type : 'unknown';
                fingerprint.pixelRatio = window.devicePixelRatio || 1;
                
                if ('deviceMemory' in navigator) {
                    fingerprint.deviceMemory = navigator.deviceMemory;
                }
                
                return fingerprint;
                
            } catch (error) {
                console.error('Error generating device fingerprint:', error);
                throw error;
            }
        }

        async function generateCanvasFingerprint() {
            try {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = 280;
                canvas.height = 60;
                
                // Text fingerprint
                ctx.textBaseline = 'top';
                ctx.font = '14px Arial';
                ctx.fillStyle = '#f60';
                ctx.fillRect(125, 1, 62, 20);
                ctx.fillStyle = '#069';
                ctx.fillText('Device Verification 🔐', 2, 15);
                ctx.fillStyle = 'rgba(102, 204, 0, 0.7)';
                ctx.fillText('Canvas fingerprint', 4, 17);
                
                // Emoji and shapes
                ctx.font = '18px Arial';
                ctx.fillText('🌟💻📱🔒', 50, 35);
                
                // Get image data and create hash
                const imageData = canvas.toDataURL();
                return simpleHash(imageData);
                
            } catch (error) {
                return 'canvas-error';
            }
        }

        async function getWebGLInfo() {
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl') || canvas.getContext('experimental-webgl');
                
                if (!gl) return null;
                
                const debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
                
                const info = {
                    vendor: gl.getParameter(gl.VENDOR),
                    renderer: gl.getParameter(gl.RENDERER),
                    version: gl.getParameter(gl.VERSION),
                    shadingLanguageVersion: gl.getParameter(gl.SHADING_LANGUAGE_VERSION)
                };
                
                if (debugInfo) {
                    info.unmaskedVendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
                    info.unmaskedRenderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
                }
                
                return info;
            } catch (error) {
                return null;
            }
        }

        async function generateAudioFingerprint() {
            try {
                if (!window.AudioContext && !window.webkitAudioContext) return null;
                
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                return new Promise((resolve) => {
                    const oscillator = audioContext.createOscillator();
                    const analyser = audioContext.createAnalyser();
                    const gainNode = audioContext.createGain();
                    const scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);
                    
                    oscillator.type = 'triangle';
                    oscillator.frequency.setValueAtTime(10000, audioContext.currentTime);
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    
                    oscillator.connect(analyser);
                    analyser.connect(scriptProcessor);
                    scriptProcessor.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.start(0);
                    
                    let samples = [];
                    
                    scriptProcessor.addEventListener('audioprocess', function(event) {
                        const inputBuffer = event.inputBuffer;
                        const inputData = inputBuffer.getChannelData(0);
                        
                        for (let i = 0; i < inputData.length; i++) {
                            samples.push(inputData[i]);
                        }
                        
                        if (samples.length >= 4096) {
                            oscillator.stop();
                            audioContext.close();
                            
                            let hash = 0;
                            for (let i = 0; i < samples.length; i++) {
                                hash += Math.abs(samples[i]);
                            }
                            
                            resolve(hash.toString());
                        }
                    });
                    
                    // Fallback timeout
                    setTimeout(() => {
                        try {
                            oscillator.stop();
                            audioContext.close();
                        } catch (e) {}
                        resolve('audio-timeout');
                    }, 1000);
                });
                
            } catch (error) {
                return 'audio-error';
            }
        }

        async function detectAvailableFonts() {
            const baseFonts = ['monospace', 'sans-serif', 'serif'];
            const testFonts = [
                'Arial', 'Helvetica', 'Times New Roman', 'Courier New', 'Verdana',
                'Georgia', 'Palatino', 'Garamond', 'Bookman', 'Comic Sans MS',
                'Trebuchet MS', 'Arial Black', 'Impact', 'Lucida Console',
                'Tahoma', 'Calibri', 'Cambria', 'Franklin Gothic Medium'
            ];
            
            const detectedFonts = [];
            
            for (const font of testFonts.slice(0, 8)) { // Limit for performance
                if (await isFontAvailable(font, baseFonts)) {
                    detectedFonts.push(font);
                }
            }
            
            return detectedFonts;
        }

        async function isFontAvailable(font, baseFonts) {
            const testString = 'mmmmmmmmmmlli';
            const testSize = '72px';
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            // Get baseline widths
            const baselineWidths = baseFonts.map(baseFont => {
                context.font = `${testSize} ${baseFont}`;
                return context.measureText(testString).width;
            });
            
            // Test target font
            for (let i = 0; i < baseFonts.length; i++) {
                context.font = `${testSize} ${font}, ${baseFonts[i]}`;
                const width = context.measureText(testString).width;
                if (width !== baselineWidths[i]) {
                    return true;
                }
            }
            
            return false;
        }

        function simpleHash(str) {
            let hash = 0;
            if (str.length === 0) return hash.toString();
            
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            
            return Math.abs(hash).toString();
        }

        // Main Application Functions
        function getUserIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('user_id');
        }

        function getSimpleBrowserName(userAgent) {
            if (userAgent.includes('Chrome')) return 'Chrome';
            if (userAgent.includes('Firefox')) return 'Firefox';
            if (userAgent.includes('Safari')) return 'Safari';
            if (userAgent.includes('Edge')) return 'Edge';
            return 'Unknown';
        }

        async function initializeVerification() {
            try {
                // Get user ID from URL
                telegramUserId = getUserIdFromURL();
                if (!telegramUserId) {
                    showResult(false, 'Error', 'Telegram User ID नहीं मिली। Bot से फिर से try करें।');
                    return;
                }

                document.getElementById('telegramUserId').value = telegramUserId;

                // Show progress
                const progressBar = document.getElementById('loadingProgress');
                let progress = 0;
                
                const progressInterval = setInterval(() => {
                    progress += Math.random() * 20;
                    if (progress >= 90) progress = 90;
                    progressBar.style.width = progress + '%';
                }, 200);

                // Generate device fingerprint
                deviceFingerprint = await generateDeviceFingerprint();
                
                // Complete progress
                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                
                setTimeout(() => {
                    // Display device information
                    const deviceDetails = document.getElementById('deviceDetails');
                    deviceDetails.innerHTML = `
                        <div class="row g-2">
                            <div class="col-6"><strong><i class="fas fa-globe me-1"></i>Browser:</strong></div>
                            <div class="col-6">${getSimpleBrowserName(deviceFingerprint.userAgent)}</div>
                            <div class="col-6"><strong><i class="fas fa-desktop me-1"></i>Platform:</strong></div>
                            <div class="col-6">${deviceFingerprint.platform}</div>
                            <div class="col-6"><strong><i class="fas fa-tv me-1"></i>Screen:</strong></div>
                            <div class="col-6">${deviceFingerprint.screen}</div>
                            <div class="col-6"><strong><i class="fas fa-clock me-1"></i>Timezone:</strong></div>
                            <div class="col-6">${deviceFingerprint.timezone}</div>
                            <div class="col-6"><strong><i class="fas fa-language me-1"></i>Language:</strong></div>
                            <div class="col-6">${deviceFingerprint.language}</div>
                            <div class="col-6"><strong><i class="fas fa-fingerprint me-1"></i>Touch:</strong></div>
                            <div class="col-6">${deviceFingerprint.touchSupport ? 'Yes' : 'No'}</div>
                        </div>
                    `;
                    
                    // Hide loading and show form
                    document.getElementById('loadingState').classList.add('d-none');
                    document.getElementById('verificationForm').classList.remove('d-none');
                }, 1000);
                
            } catch (error) {
                console.error('Initialization error:', error);
                showResult(false, 'Initialization Failed', 'Device information collect नहीं हो सकी। Please try again।');
            }
        }
        
        async function verifyDevice() {
            const verifyBtn = document.getElementById('verifyBtn');
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verify कर रहे हैं...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/verify_device`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        user_id: telegramUserId,
                        fingerprint: deviceFingerprint
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.success) {
                    showResult(true, 'Verification Successful! ✅', result.message);
                } else {
                    showResult(false, 'Verification Failed! ❌', result.message || 'Verification fail हो गई।');
                }
                
            } catch (error) {
                console.error('Verification error:', error);
                showResult(false, 'Network Error', 'Connection problem है। Internet check करके फिर से try करें।');
            }
        }
        
        function showResult(success, title, message) {
            // Hide form
            document.getElementById('verificationForm').classList.add('d-none');
            
            // Show result
            const resultState = document.getElementById('resultState');
            const resultIcon = document.getElementById('resultIcon');
            const resultTitle = document.getElementById('resultTitle');
            const resultMessage = document.getElementById('resultMessage');
            
            if (success) {
                resultIcon.innerHTML = '<i class="fas fa-check-circle status-success"></i>';
                resultTitle.className = 'text-success';
            } else {
                resultIcon.innerHTML = '<i class="fas fa-times-circle status-error"></i>';
                resultTitle.className = 'text-danger';
            }
            
            resultTitle.textContent = title;
            resultMessage.textContent = message;
            resultState.classList.remove('d-none');
        }

        function goBackToBot() {
            // Try to go back to Telegram
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.close();
            } else {
                // Fallback: try to open Telegram
                window.open('https://t.me/your_bot_username', '_blank');
            }
        }
        
        // Initialize when page loads
        window.addEventListener('load', initializeVerification);

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                console.log('Page hidden');
            } else {
                console.log('Page visible');
            }
        });
    </script>
</body>
</html>
